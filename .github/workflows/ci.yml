name: CI Pipeline

# –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ci:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.12]

    steps:
      # 1Ô∏è‚É£ Checkout –ø—Ä–æ–µ–∫—Ç–∞
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python –∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ pip
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      # 3Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ UV –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: Install UV
        run: |
          python -m pip install --upgrade pip
          pip install uv

      # 4Ô∏è‚É£ –ö–µ—à–∏—Ä—É–µ–º virtualenv UV –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤
      - name: Cache UV virtualenv
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      # 5Ô∏è‚É£ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞ —á–µ—Ä–µ–∑ UV
      - name: Sync dependencies
        run: uv sync

      # 6Ô∏è‚É£ Pre-commit checks (—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –ª–∏–Ω—Ç–µ—Ä—ã –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
      - name: Run Pre-commit checks
        uses: pre-commit/action@v3.0.0
        with:
          extra_args: --all-files

      - name: Clear pre-commit cache
        run: pre-commit clean

      # 7Ô∏è‚É£ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏
      - name: Run Mypy
        run: uv run mypy src/

      # 8Ô∏è‚É£ –õ–∏–Ω—Ç–µ—Ä
      - name: Run Ruff
        run: uv run ruff check src/

      # 9Ô∏è‚É£ –¢–µ—Å—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞
      - name: Run Tests
        env:
          ENV: test
          MAIL_USERNAME: test@example.com
          MAIL_PASSWORD: testpass
        run: uv run pytest -v --disable-warnings --maxfail=1

      # üîí 10Ô∏è‚É£ –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: Dependency security audit (pip-audit)
        run: uv run pip-audit --format=human

      - name: Static security scan (Bandit)
        run: uv run bandit -r src -ll

      - name: Safety scan
        run: uv run safety scan

      # 11Ô∏è‚É£ CodeQL security scanning
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      # 12Ô∏è‚É£ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫—ç—à pytest –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤
      - name: Upload pytest cache
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-cache
          path: .pytest_cache/
